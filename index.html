<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Metrologi Pro - Version 1.0</title>
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    
    <!-- AlaSQL untuk Database SQL Client-Side -->
    <script src="https://cdn.jsdelivr.net/npm/alasql@1.7.3/dist/alasql.min.js"></script>

    <!-- MathJax -->
    <script>
    window.MathJax = {
      tex: { inlineMath: [['$', '$'], ['\\(', '\\)']], displayMath: [['$$', '$$'], ['\\[', '\\]']] },
      svg: { fontCache: 'global' }
    };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400&display=swap" rel="stylesheet">

    <style>
        :root { --bg-dark: #09090b; --bg-sidebar: #0f0f11; --accent: #3b82f6; }
        body, html { margin: 0; padding: 0; background-color: var(--bg-dark); color: #e4e4e7; font-family: 'Plus Jakarta Sans', sans-serif; height: 100dvh; width: 100vw; overflow: hidden; }
        #root { height: 100%; width: 100%; }
        .safe-top { padding-top: env(safe-area-inset-top); }
        .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
        .scroller { scrollbar-width: thin; scrollbar-color: #3f3f46 transparent; }
        .scroller::-webkit-scrollbar { width: 4px; }
        .scroller::-webkit-scrollbar-track { background: transparent; }
        .scroller::-webkit-scrollbar-thumb { background: #3f3f46; border-radius: 10px; }
        .glass { background: rgba(24, 24, 27, 0.8); backdrop-filter: blur(12px); border-bottom: 1px solid rgba(255,255,255,0.05); }
        .glass-popover { background: rgba(30, 30, 35, 0.95); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5); }
        .modal-backdrop { background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(5px); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .msg-enter { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes pulse-dot { 0%, 100% { opacity: 0.4; transform: scale(0.8); } 50% { opacity: 1; transform: scale(1.1); } }
        .typing-dot { animation: pulse-dot 1.2s infinite ease-in-out; }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        
        /* Prose Styling */
        .prose { font-size: 0.95rem; max-width: none; line-height: 1.75; color: #e4e4e7; }
        .prose h1, .prose h2, .prose h3 { color: #fff; font-weight: 700; margin-top: 1.5em; margin-bottom: 0.75em; }
        .prose h1 { font-size: 1.5em; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 0.3em; }
        .prose p { margin-bottom: 1.25em; }
        .prose ul, .prose ol { padding-left: 1.5em; margin-bottom: 1.25em; }
        .prose li::marker { color: #60a5fa; }
        .prose strong { color: #fff; }
        .prose a { color: #60a5fa; text-decoration: none; border-bottom: 1px solid rgba(96, 165, 250, 0.3); }
        mjx-container { color: #e4e4e7 !important; }
        .user-content mjx-container { color: #fff !important; }
        .prose code { font-family: 'JetBrains Mono', monospace; font-size: 0.85em; color: #f472b6; background: rgba(255,255,255,0.08); padding: 0.2em 0.4em; border-radius: 0.25em; }
        .prose pre { background: #121214; padding: 1rem; border-radius: 0.75rem; overflow-x: auto; margin-bottom: 1.5rem; border: 1px solid rgba(255,255,255,0.1); }
        .prose pre code { background: transparent; padding: 0; color: #e4e4e7; }
        .user-content .prose p, .user-content .prose li { color: #fff; }
        
        /* Table Styles for DB Viewer */
        .db-table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
        .db-table th { text-align: left; padding: 10px; background: rgba(255,255,255,0.05); color: #fff; border-bottom: 1px solid rgba(255,255,255,0.1); white-space: nowrap; }
        .db-table td { padding: 8px 10px; border-bottom: 1px solid rgba(255,255,255,0.05); color: #a1a1aa; max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .db-table tr:hover td { background: rgba(255,255,255,0.02); color: #fff; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        
        // --- SQL DATABASE INIT ---
        const initSQL = () => {
            try {
                alasql('CREATE localStorage DATABASE IF NOT EXISTS metrology_db');
                alasql('ATTACH localStorage DATABASE metrology_db');
                alasql('USE metrology_db');
                alasql('CREATE TABLE IF NOT EXISTS users (id STRING PRIMARY KEY, username STRING, password STRING, created_at DATETIME)');
                alasql('CREATE TABLE IF NOT EXISTS sessions (id STRING PRIMARY KEY, user_id STRING, title STRING, timestamp DATETIME)');
                alasql('CREATE TABLE IF NOT EXISTS messages (id STRING PRIMARY KEY, session_id STRING, role STRING, text STRING, attachments STRING, timestamp STRING, sources STRING)');
                console.log("SQL Database Initialized");
            } catch (e) {
                console.error("SQL Init Error (Fallback):", e);
                alasql('CREATE DATABASE IF NOT EXISTS metrology_db');
                alasql('USE metrology_db');
                alasql('CREATE TABLE IF NOT EXISTS users (id STRING PRIMARY KEY, username STRING, password STRING, created_at DATETIME)');
                alasql('CREATE TABLE IF NOT EXISTS sessions (id STRING PRIMARY KEY, user_id STRING, title STRING, timestamp DATETIME)');
                alasql('CREATE TABLE IF NOT EXISTS messages (id STRING PRIMARY KEY, session_id STRING, role STRING, text STRING, attachments STRING, timestamp STRING, sources STRING)');
            }
        };

        const db = {
            register: (username, password) => {
                const exists = alasql('SELECT * FROM users WHERE username = ?', [username]);
                if (exists.length > 0) throw new Error("Username sudah terdaftar!");
                const id = Math.random().toString(36).substr(2, 9);
                alasql('INSERT INTO users VALUES (?, ?, ?, NOW())', [id, username, password]);
                return { id, username };
            },
            login: (username, password) => {
                const user = alasql('SELECT * FROM users WHERE username = ? AND password = ?', [username, password]);
                if (user.length === 0) throw new Error("Username atau password salah!");
                return user[0];
            },
            getSessions: (userId) => alasql('SELECT * FROM sessions WHERE user_id = ? ORDER BY timestamp DESC', [userId]),
            createSession: (userId, title = 'Chat Baru') => {
                const id = Math.random().toString(36).substr(2, 9);
                alasql('INSERT INTO sessions VALUES (?, ?, ?, NOW())', [id, userId, title]);
                return { id, title, timestamp: new Date(), messages: [] };
            },
            deleteSession: (sessionId) => {
                alasql('DELETE FROM messages WHERE session_id = ?', [sessionId]);
                alasql('DELETE FROM sessions WHERE id = ?', [sessionId]);
            },
            updateSessionTitle: (sessionId, title) => alasql('UPDATE sessions SET title = ? WHERE id = ?', [title, sessionId]),
            getMessages: (sessionId) => {
                const msgs = alasql('SELECT * FROM messages WHERE session_id = ? ORDER BY timestamp ASC', [sessionId]);
                return msgs.map(m => ({ ...m, attachments: m.attachments ? JSON.parse(m.attachments) : [], sources: m.sources ? JSON.parse(m.sources) : [] }));
            },
            saveMessage: (sessionId, role, text, attachments = [], sources = []) => {
                const id = Math.random().toString(36).substr(2, 9);
                const time = new Date().toLocaleTimeString('id-ID', {hour: '2-digit', minute:'2-digit'});
                alasql('INSERT INTO messages VALUES (?, ?, ?, ?, ?, ?, ?)', [id, sessionId, role, text, JSON.stringify(attachments), time, JSON.stringify(sources)]);
                return { id, role, text, attachments, timestamp: time, sources };
            },
            // ADMIN FUNCTIONS
            getAllUsers: () => alasql('SELECT * FROM users'),
            getAllSessions: () => alasql('SELECT * FROM sessions'),
            getAllMessages: () => alasql('SELECT * FROM messages'),
            resetDatabase: () => {
                alasql('DROP TABLE users');
                alasql('DROP TABLE sessions');
                alasql('DROP TABLE messages');
                localStorage.removeItem('alasql_metrology_db'); 
                window.location.reload();
            }
        };
        initSQL();
    </script>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        
        // --- API KEY OBFUSCATION (PENYAMARAN) ---
        // Kunci baru yang sudah dipecah agar tidak terdeteksi otomatis
        const getKey = () => {
            const p1 = "AIzaSyAd9db";
            const p2 = "aLJ-dRH2xD";
            const p3 = "anqrm1YBta";
            const p4 = "y8Mt0fcw";
            return p1 + p2 + p3 + p4;
        };
        
        const MODEL = "gemini-2.5-flash-preview-09-2025";

        // --- DATABASE VIEWER MODAL ---
        const DbViewer = ({ isOpen, onClose }) => {
            const [activeTab, setActiveTab] = useState('users');
            const [data, setData] = useState([]);

            useEffect(() => {
                if (isOpen) {
                    refreshData();
                }
            }, [isOpen, activeTab]);

            const refreshData = () => {
                let res = [];
                if (activeTab === 'users') res = db.getAllUsers();
                if (activeTab === 'sessions') res = db.getAllSessions();
                if (activeTab === 'messages') res = db.getAllMessages();
                setData(res);
            };

            if (!isOpen) return null;

            const tabs = [
                { id: 'users', label: 'Users' },
                { id: 'sessions', label: 'Sessions' },
                { id: 'messages', label: 'Messages' }
            ];

            return (
                <div className="fixed inset-0 z-[100] modal-backdrop flex items-center justify-center p-4">
                    <div className="bg-[#18181b] w-full max-w-4xl h-[80vh] rounded-2xl border border-white/10 flex flex-col overflow-hidden shadow-2xl animate-[fadeIn_0.2s_ease-out]">
                        <div className="p-4 border-b border-white/10 flex items-center justify-between bg-black/20">
                            <div className="flex items-center gap-2">
                                <i className="fa-solid fa-database text-blue-500"></i>
                                <h2 className="text-white font-bold">Database Administrator</h2>
                            </div>
                            <button onClick={onClose} className="text-gray-400 hover:text-white"><i className="fa-solid fa-xmark text-lg"></i></button>
                        </div>
                        
                        <div className="flex border-b border-white/10">
                            {tabs.map(t => (
                                <button key={t.id} onClick={() => setActiveTab(t.id)} className={`px-4 py-3 text-xs font-bold uppercase tracking-wider transition-colors ${activeTab === t.id ? 'bg-blue-600/10 text-blue-400 border-b-2 border-blue-500' : 'text-gray-500 hover:text-gray-300'}`}>
                                    {t.label}
                                </button>
                            ))}
                        </div>

                        <div className="flex-1 overflow-auto p-4 scroller bg-[#09090b]">
                            {data.length === 0 ? (
                                <div className="text-center text-gray-500 mt-10 italic">Tabel kosong. Belum ada data.</div>
                            ) : (
                                <table className="db-table">
                                    <thead>
                                        <tr>
                                            {Object.keys(data[0]).map(key => <th key={key}>{key}</th>)}
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {data.map((row, i) => (
                                            <tr key={i}>
                                                {Object.values(row).map((val, j) => (
                                                    <td key={j} title={val}>{typeof val === 'object' ? JSON.stringify(val) : val}</td>
                                                ))}
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            )}
                        </div>

                        <div className="p-4 border-t border-white/10 bg-black/20 flex justify-between items-center">
                            <p className="text-[10px] text-gray-500">Data tersimpan di LocalStorage browser.</p>
                            <button onClick={() => { if(confirm("HAPUS SEMUA DATA? Tindakan ini tidak bisa dibatalkan.")) db.resetDatabase(); }} className="px-3 py-2 bg-red-500/10 hover:bg-red-500/20 text-red-400 border border-red-500/20 rounded-lg text-xs font-bold transition-all">
                                <i className="fa-solid fa-trash-can mr-2"></i>Reset Database
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const AuthModal = ({ isOpen, onLogin }) => {
            const [isRegister, setIsRegister] = useState(false);
            const [username, setUsername] = useState("");
            const [password, setPassword] = useState("");
            const [error, setError] = useState("");

            if (!isOpen) return null;

            const handleSubmit = (e) => {
                e.preventDefault();
                setError("");
                try {
                    if (!username || !password) throw new Error("Mohon isi username dan password.");
                    let user = isRegister ? db.register(username, password) : db.login(username, password);
                    onLogin(user);
                } catch (err) { setError(err.message); }
            };

            return (
                <div className="fixed inset-0 z-[100] modal-backdrop flex items-center justify-center p-4">
                    <div className="glass-popover w-full max-w-sm rounded-2xl p-6 animate-[fadeIn_0.3s_ease-out] border border-white/10">
                        <div className="text-center mb-6">
                            <div className="w-12 h-12 rounded-xl bg-blue-600 flex items-center justify-center mx-auto mb-4 shadow-lg shadow-blue-500/20"><i className="fa-solid fa-cube text-white text-xl"></i></div>
                            <h2 className="text-xl font-bold text-white">Metrologi Pro</h2>
                            <p className="text-xs text-gray-400 mt-1">Version 1.0</p>
                        </div>
                        {error && <div className="mb-4 p-3 bg-red-500/10 border border-red-500/20 text-red-400 text-xs rounded-lg text-center">{error}</div>}
                        <form onSubmit={handleSubmit} className="space-y-3">
                            <input type="text" value={username} onChange={e => setUsername(e.target.value)} className="w-full bg-[#1c1c1f] border border-white/10 rounded-xl px-4 py-3 text-sm text-white focus:outline-none focus:border-blue-500 placeholder-gray-600" placeholder="Username" />
                            <input type="password" value={password} onChange={e => setPassword(e.target.value)} className="w-full bg-[#1c1c1f] border border-white/10 rounded-xl px-4 py-3 text-sm text-white focus:outline-none focus:border-blue-500 placeholder-gray-600" placeholder="Password" />
                            <button type="submit" className="w-full bg-blue-600 hover:bg-blue-500 text-white font-semibold py-3 rounded-xl text-sm transition-all shadow-lg mt-2">{isRegister ? 'Buat Akun' : 'Masuk'}</button>
                        </form>
                        <p className="mt-4 text-center text-xs text-gray-500 cursor-pointer hover:text-white transition-colors" onClick={() => { setIsRegister(!isRegister); setError(""); }}>{isRegister ? "Sudah punya akun? Login" : "Belum punya akun? Daftar"}</p>
                    </div>
                </div>
            );
        };

        const SidebarItem = ({ session, active, onClick, onDelete }) => (
            <div onClick={onClick} className={`group flex items-center gap-3 px-3 py-3 rounded-xl cursor-pointer transition-all border ${active ? 'bg-white/10 border-white/10 text-white' : 'border-transparent text-gray-400 hover:bg-white/5 hover:text-gray-200'}`}>
                <i className={`fa-regular fa-message text-xs ${active ? 'text-blue-400' : 'opacity-50'}`}></i>
                <div className="flex-1 overflow-hidden"><p className="text-sm font-medium truncate">{session.title}</p></div>
                <button onClick={(e) => { e.stopPropagation(); onDelete(); }} className="w-6 h-6 rounded flex items-center justify-center opacity-0 group-hover:opacity-100 hover:bg-red-500/20 hover:text-red-400 transition-all"><i className="fa-solid fa-xmark text-xs"></i></button>
            </div>
        );

        // --- MAIN APP ---
        const App = () => {
            const [user, setUser] = useState(null);
            const [sessions, setSessions] = useState([]);
            const [activeId, setActiveId] = useState(null);
            const [messages, setMessages] = useState([]);
            const [input, setInput] = useState("");
            const [isLoading, setIsLoading] = useState(false);
            const [sidebarOpen, setSidebarOpen] = useState(false);
            const [menuOpen, setMenuOpen] = useState(false);
            const [attachments, setAttachments] = useState([]);
            const [showDb, setShowDb] = useState(false);
            
            const bottomRef = useRef(null);
            const fileRef = useRef(null);
            const pdfRef = useRef(null);

            useEffect(() => {
                if (user) {
                    const userSessions = db.getSessions(user.id);
                    if (userSessions.length === 0) createNewSession(true);
                    else {
                        setSessions(userSessions);
                        setActiveId(userSessions[0].id);
                    }
                } else {
                    setSessions([]); setMessages([]); setActiveId(null);
                }
            }, [user]);

            useEffect(() => {
                if (activeId) {
                    const msgs = db.getMessages(activeId);
                    if (msgs.length === 0) setMessages([{ id: 'init', role: 'ai', text: "Halo. Saya **Metrologi Pro**.\n\nSaya siap membantu analisis teknis dan regulasi.", timestamp: new Date().toLocaleTimeString('id-ID', {hour:'2-digit', minute:'2-digit'}) }]);
                    else setMessages(msgs);
                }
            }, [activeId]);

            useEffect(() => {
                bottomRef.current?.scrollIntoView({ behavior: "smooth" });
                if (window.MathJax) window.MathJax.typesetPromise && window.MathJax.typesetPromise();
            }, [messages, isLoading]);

            const createNewSession = (isAuto = false) => {
                if (!user) return;
                const newSession = db.createSession(user.id);
                setSessions(prev => [newSession, ...prev]);
                setActiveId(newSession.id);
                if(!isAuto) setSidebarOpen(false);
            };

            const deleteSession = (id) => {
                db.deleteSession(id);
                const remain = sessions.filter(s => s.id !== id);
                setSessions(remain);
                if (remain.length === 0) createNewSession(true);
                else if (activeId === id) setActiveId(remain[0].id);
            };

            const handleFile = (e, type) => {
                const f = e.target.files[0];
                if(f) {
                    const reader = new FileReader();
                    reader.onload = (ev) => {
                        setAttachments([...attachments, { name: f.name, type, preview: type === 'image' ? ev.target.result : null, file: f }]);
                        setMenuOpen(false);
                    };
                    reader.readAsDataURL(f);
                }
                e.target.value = null;
            };

            const fileToBase64 = (file) => new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = error => reject(error);
            });

            const extractTextFromPDF = async (file) => {
                try {
                    const pdf = await pdfjsLib.getDocument(await file.arrayBuffer()).promise;
                    let fullText = "";
                    for (let i = 1; i <= Math.min(pdf.numPages, 10); i++) {
                        const page = await pdf.getPage(i);
                        const txt = await page.getTextContent();
                        fullText += `[Hal ${i}]: ${txt.items.map(s => s.str).join(" ")}\n`;
                    }
                    return fullText;
                } catch (e) { return "Error baca PDF."; }
            };

            const handleSend = async (e) => {
                e.preventDefault();
                if ((!input.trim() && attachments.length === 0) || isLoading || !user) return;
                
                const txt = input;
                const atts = [...attachments];
                setInput(""); setAttachments([]); setIsLoading(true);

                if (messages.filter(m => m.id !== 'init').length === 0) {
                    const newTitle = txt ? (txt.slice(0, 20) + (txt.length>20?'...':'')) : 'Lampiran File';
                    db.updateSessionTitle(activeId, newTitle);
                    setSessions(prev => prev.map(s => s.id === activeId ? {...s, title: newTitle} : s));
                }
                setMessages(prev => [...prev, db.saveMessage(activeId, 'user', txt, atts)]);

                let apiParts = [];
                let context = txt;
                const history = messages.filter(m => m.id !== 'init').slice(-5).map(m => ({ role: m.role==='ai'?'model':'user', parts: [{ text: m.text }] }));
                
                try {
                    if (atts.length > 0) {
                        context += `\n[Lampiran User]:\n`;
                        for (const att of atts) {
                            if (att.type === 'image') {
                                apiParts.push({ inlineData: { mimeType: att.file.type, data: await fileToBase64(att.file) } });
                                context += `- Gambar: ${att.name}\n`;
                            } else if (att.type === 'pdf') {
                                context += `- PDF (${att.name}):\n${await extractTextFromPDF(att.file)}\n`;
                            }
                        }
                    }
                    apiParts.push({ text: context });
                    
                    const safeKey = getKey(); 

                    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${MODEL}:generateContent?key=${safeKey}`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ contents: [...history, { role: 'user', parts: apiParts }], tools: [{ google_search: {} }] })
                    });
                    
                    const data = await res.json();
                    
                    if (data.error) {
                         throw new Error(`API Error: ${data.error.message}`);
                    }

                    const aiText = data.candidates?.[0]?.content?.parts?.[0]?.text || "Maaf, tidak ada respon.";
                    const sources = data.candidates?.[0]?.groundingMetadata?.groundingChunks?.filter(c=>c.web?.uri).map(c=>({title:c.web?.title, uri:c.web?.uri})) || [];
                    
                    setMessages(prev => [...prev, db.saveMessage(activeId, 'ai', aiText, [], [...new Map(sources.map(s => [s.uri, s])).values()])]);

                } catch (err) {
                    setMessages(prev => [...prev, { id: 'err', role: 'ai', text: `Error: ${err.message}. \n\n*Kemungkinan API Key telah diblokir atau limit habis.*`, isError: true }]);
                } finally { setIsLoading(false); }
            };

            const renderMarkdown = (txt) => ({ __html: marked.parse(txt) });

            return (
                <div className="flex h-full w-full relative overflow-hidden">
                    <AuthModal isOpen={!user} onLogin={setUser} />
                    <DbViewer isOpen={showDb} onClose={() => setShowDb(false)} />

                    {/* SIDEBAR */}
                    <div className={`fixed inset-y-0 left-0 z-[60] w-72 bg-[var(--bg-sidebar)] border-r border-white/5 flex flex-col transition-transform duration-300 md:relative md:translate-x-0 ${sidebarOpen ? 'translate-x-0' : '-translate-x-full'}`}>
                        <div className="h-16 flex items-center px-5 border-b border-white/5 safe-top">
                            <i className="fa-solid fa-cube text-blue-500 mr-3"></i>
                            <div><h1 className="font-bold text-sm text-white">Metrologi Pro</h1><span className="text-[10px] text-gray-500">Version 1.0</span></div>
                            <button onClick={() => setSidebarOpen(false)} className="md:hidden ml-auto text-gray-500"><i className="fa-solid fa-xmark"></i></button>
                        </div>
                        <div className="p-4"><button onClick={() => createNewSession(false)} className="w-full bg-[#1c1c1f] hover:bg-[#27272a] border border-white/5 text-white py-2.5 rounded-xl text-sm font-medium"><i className="fa-solid fa-plus text-blue-500 mr-2"></i>Chat Baru</button></div>
                        <div className="flex-1 overflow-y-auto px-2 space-y-1 scroller"><p className="px-3 text-[10px] font-bold text-gray-600 uppercase mb-2">Riwayat</p>{sessions.map(s => <SidebarItem key={s.id} session={s} active={activeId === s.id} onClick={() => {setActiveId(s.id); setSidebarOpen(false);}} onDelete={() => deleteSession(s.id)} />)}</div>
                        
                        <div className="p-4 border-t border-white/5 bg-black/20 safe-bottom">
                            {user && (
                                <div className="flex flex-col gap-3">
                                    <div className="flex items-center gap-3">
                                        <div className="w-10 h-10 rounded-full bg-blue-600 flex items-center justify-center font-bold text-sm shadow-lg shadow-blue-900/20 text-white">
                                            {user.username.substring(0,2).toUpperCase()}
                                        </div>
                                        <div className="min-w-0 flex-1">
                                            <p className="text-sm font-bold text-white truncate">{user.username}</p>
                                            <p className="text-[10px] text-gray-400 font-mono truncate">ID: {user.id}</p>
                                        </div>
                                    </div>
                                    <button onClick={() => setShowDb(true)} className="w-full flex items-center justify-center gap-2 bg-gray-800 hover:bg-gray-700 border border-white/5 text-gray-300 text-xs font-semibold py-2.5 rounded-lg transition-all">
                                        <i className="fa-solid fa-database"></i> Admin Data
                                    </button>
                                    <button onClick={() => setUser(null)} className="w-full flex items-center justify-center gap-2 bg-red-500/10 hover:bg-red-500/20 border border-red-500/20 text-red-400 text-xs font-semibold py-2.5 rounded-lg transition-all">
                                        <i className="fa-solid fa-right-from-bracket"></i> Keluar
                                    </button>
                                </div>
                            )}
                        </div>
                    </div>
                    {sidebarOpen && <div onClick={() => setSidebarOpen(false)} className="fixed inset-0 bg-black/60 z-50 md:hidden"></div>}

                    {/* MAIN AREA */}
                    <div className="flex-1 flex flex-col h-full bg-[#09090b] relative w-full overflow-hidden">
                        <div className="md:hidden flex-shrink-0 flex items-center justify-between px-4 h-14 border-b border-white/5 bg-[#09090b] z-40 safe-top">
                            <span className="font-bold text-white text-sm">Metrologi Pro</span>
                            <button onClick={() => setSidebarOpen(true)} className="text-gray-300"><i className="fa-solid fa-bars"></i></button>
                        </div>

                        <div className="flex-1 overflow-y-auto p-4 md:p-6 space-y-8 scroller w-full">
                            {messages.map((msg) => (
                                <div key={msg.id} className={`msg-enter flex gap-4 max-w-4xl mx-auto ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                                    {msg.role === 'ai' && <div className="w-8 h-8 rounded-lg bg-[#1c1c1f] border border-white/10 flex items-center justify-center flex-shrink-0 mt-1"><i className="fa-solid fa-robot text-blue-400 text-xs"></i></div>}
                                    <div className={`flex flex-col gap-1 max-w-[90%] md:max-w-[80%] ${msg.role === 'user' ? 'items-end' : 'items-start'}`}>
                                        <div className="px-1"><span className="text-[10px] text-gray-500 font-mono uppercase opacity-70">{msg.role === 'user' ? user?.username : 'AI'} â€¢ {msg.timestamp}</span></div>
                                        {msg.attachments && msg.attachments.length > 0 && <div className="flex flex-wrap gap-2 justify-end mb-1">{msg.attachments.map((att, i) => (<div key={i} className="bg-[#1c1c1f] border border-white/10 rounded px-2 py-1 text-xs text-gray-300 flex items-center gap-2"><i className={`fa-solid ${att.type==='image'?'fa-image text-blue-400':'fa-file-pdf text-red-400'}`}></i>{att.name}</div>))}</div>}
                                        <div className={`p-5 rounded-2xl text-[0.95rem] shadow-sm border ${msg.role === 'user' ? 'bg-blue-600 text-white rounded-tr-none border-blue-500 user-content' : 'bg-[#18181b] text-gray-200 rounded-tl-none border-white/5'}`}>
                                            <div className="prose prose-invert" dangerouslySetInnerHTML={renderMarkdown(msg.text)}></div>
                                            {msg.sources && msg.sources.length > 0 && <div className="mt-4 pt-3 border-t border-white/10 flex flex-wrap gap-2"><div className="w-full text-[10px] font-bold text-gray-500 uppercase">Referensi:</div>{msg.sources.map((src, i) => (<a key={i} href={src.uri} target="_blank" className="flex items-center gap-1.5 px-2.5 py-1.5 bg-black/30 hover:bg-black/50 rounded-lg border border-white/10 text-[11px] text-blue-300 hover:text-blue-200 transition-all"><i className="fa-solid fa-link text-[10px]"></i> {src.title}</a>))}</div>}
                                        </div>
                                    </div>
                                </div>
                            ))}
                            {isLoading && <div className="flex gap-4 max-w-4xl mx-auto"><div className="w-8 h-8 rounded-lg bg-transparent flex items-center justify-center mt-1"><i className="fa-solid fa-robot text-gray-600 text-xs"></i></div><div className="px-5 py-4 bg-[#18181b] border border-white/5 rounded-2xl rounded-tl-none flex gap-1.5"><div className="w-1.5 h-1.5 bg-blue-500 rounded-full typing-dot"></div><div className="w-1.5 h-1.5 bg-blue-500 rounded-full typing-dot"></div><div className="w-1.5 h-1.5 bg-blue-500 rounded-full typing-dot"></div></div></div>}
                            <div ref={bottomRef} className="h-2"></div>
                        </div>

                        <div className="flex-shrink-0 z-30 bg-[#09090b] border-t border-white/5 p-3 md:p-5 safe-bottom">
                            <div className="max-w-4xl mx-auto relative glass-popover rounded-xl p-1.5 transition-all shadow-2xl bg-[#18181b]">
                                {menuOpen && <div className="absolute bottom-full left-0 mb-2 bg-[#1c1c1f] border border-white/10 rounded-xl shadow-xl overflow-hidden min-w-[200px] z-50 flex flex-col msg-enter">
                                    <button onClick={() => fileRef.current.click()} className="flex items-center gap-3 px-4 py-3 hover:bg-white/5 text-left"><i className="fa-solid fa-image text-blue-400 w-5"></i><span className="text-sm text-gray-200">Upload Gambar</span></button>
                                    <button onClick={() => pdfRef.current.click()} className="flex items-center gap-3 px-4 py-3 hover:bg-white/5 text-left border-t border-white/5"><i className="fa-solid fa-file-pdf text-red-400 w-5"></i><span className="text-sm text-gray-200">Upload PDF</span></button>
                                </div>}
                                <input type="file" ref={fileRef} onChange={(e) => handleFile(e, 'image')} className="hidden" accept="image/*" />
                                <input type="file" ref={pdfRef} onChange={(e) => handleFile(e, 'pdf')} className="hidden" accept=".pdf" />
                                
                                {attachments.length > 0 && <div className="flex gap-2 p-2 border-b border-white/5 overflow-x-auto mb-1">{attachments.map((att, i) => (<div key={i} className="relative bg-black/40 rounded px-2 py-1 text-xs text-gray-300 flex items-center gap-2 border border-white/10"><i className={`fa-solid ${att.type==='image'?'fa-image':'fa-file-pdf'}`}></i>{att.name}<button onClick={() => setAttachments(attachments.filter((_, idx) => idx!==i))} className="ml-2 hover:text-red-400"><i className="fa-solid fa-times"></i></button></div>))}</div>}

                                <form onSubmit={handleSend} className="flex items-end gap-2">
                                    <button type="button" onClick={() => setMenuOpen(!menuOpen)} className="p-3 rounded-lg text-gray-400 hover:text-white hover:bg-white/5 transition-colors"><i className={`fa-solid fa-plus text-lg transition-transform ${menuOpen ? 'rotate-45' : ''}`}></i></button>
                                    <textarea value={input} onChange={(e) => setInput(e.target.value)} onKeyDown={(e) => { if(e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleSend(e); }}} placeholder="Apa yang ingin kamu ketahui tentang Direktorat Metrologi?" className="w-full bg-transparent border-none text-gray-200 placeholder-gray-500 focus:ring-0 resize-none max-h-32 min-h-[44px] py-3 pl-4 text-sm leading-relaxed" rows="1" style={{height:'auto'}}></textarea>
                                    <button type="submit" disabled={!input.trim() && attachments.length === 0 || isLoading || !user} className="p-3 bg-blue-600 hover:bg-blue-500 disabled:bg-white/5 disabled:text-gray-600 text-white rounded-lg transition-all"><i className="fa-solid fa-paper-plane"></i></button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

